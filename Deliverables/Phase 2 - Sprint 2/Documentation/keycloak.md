# KEYCLOAK Configuration and Best Practices

This document outlines the deployment and security configurations of the Keycloak-based authentication system used in our Library Realm, installed on a Windows Server 2022 Azure VM. It details setup scripts, realm configurations, security practices, and compliance mappings to OWASP ASVS 4.0, with suggestions for future enhancements.

## Access URLs
- **Keycloak Admin Console**: http://localhost:8080/admin/
- **Account Console**: http://localhost:8080/realms/library/account/

## Deployment Environment
- **Platform**: Azure Virtual Machine (Windows Server 2022)
- **Keycloak Version**: 26.2.5
- **Database**: MySQL 8.0 (Separate databases for application and Keycloak)
- **Access**: http://localhost:8080
- **HTTPS Enabled**: No (HTTP only)

## Prerequisites
1. Windows Server 2022 VM in Azure
2. MySQL Server 8.0 installed
3. Java 11 or later installed
4. Keycloak 26.2.5 downloaded and extracted

## Database Setup
1. Create the Keycloak database:
```sql
DROP DATABASE IF EXISTS keycloak;
CREATE DATABASE keycloak CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## Keycloak Configuration
1. Edit `keycloak.conf` in the Keycloak `conf` directory with the following settings:
```properties
db=mysql
db-username=desofs
db-password=E*bCRJ_ijo*N3u_kMMZb
db-url=jdbc:mysql://localhost:3306/keycloak
```

2. Set environment variables:
```batch
setx KEYCLOAK_ADMIN desofs-kc
setx KEYCLOAK_ADMIN_PASSWORD xc.uUrqxbz6tDYyQryhK
```
Best Practice: Create environment variables for the Keycloak admin credentials, like in Windows System Environment Variable.
Or in web.config, add as Environment Variable and add it also to appsettings.Development.json / appsettings.json. This is below.

## Automated Startup Script
Create a batch file (e.g., `start-keycloak.bat`) with the following content:
```batch
@echo off
cd /d "C:\Program Files\keycloak-26.2.5\bin"
start "" /min kc.bat start-dev 
```

## Web Configuration
Update your application's `web.config` with environment variables:
```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      <aspNetCore processPath="dotnet" arguments=".\LibraryOnlineRentalSystem.dll" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" hostingModel="inprocess">
        <environmentVariables>
          <environmentVariable name="KEYCLOAK_ADMIN" value="desofs-kc" />
          <environmentVariable name="KEYCLOAK_ADMIN_PASSWORD" value="xc.uUrqxbz6tDYyQryhK" />
        </environmentVariables>
      </aspNetCore>
    </system.webServer>
  </location>
</configuration>
```
# Script Init-Keycloak.sh

All settings are automatically generated by the script.

## Realm Configuration: library
### Realm Roles
- **Admin:** Full control of realm.

- **LibraryManager:** Intermediate control, e.g., manage clients/users.

- **User:** Default for self-registered users.

### Configuration

#### **Realm Settings**

- **HTTPS Required:** All external traffic (port 8443)

- **Default Role:** User

- **Token lifespan:** 2h

- **Self-Registration Enabled:** enabled

- **First/Last Name Required:** removed

#### **Clients**
***library-client***
- clientAuthenticatorType: client-secret

- Flows Enabled:

        directAccessGrantsEnabled: enabled

        serviceAccountsEnabled: enabled

        authorizationServicesEnabled: enabled

        standardFlowEnabled: enabled

        implicitFlowEnabled: enabled

#### **Realm Settings - Email (SMTP) Configuration**

- **SMTP:** Gmail or Outlook SMTP

- **Port:** 587 (TLS)

- Enabled Features:
    - Authentication (APP password)
    - TLS

- Add Email From and Display Name

#### **Realm Settings - Required Actions**

- Enable VERIFY_EMAIL

- Click "Default Action" on VERIFY_EMAIL

- Enable CONFIGURE_TOTP

- Click "Default Action" on CONFIGURE_TOTP

**ASVS** Mappings:

 - 2.1.1 & 2.1.3 – Email verification

 - 2.1.4 – TOTP/MFA requirement

#### **Authentication Flows**

Authentication - Flows - Browser with Email First

- Username Password Form - **Required**

- OTP Form - **Required**

- Set to **Bind Flow with Browser** (to become default browser flow)

Authentication - Flow - Registration

- Add Execution: **Verify Email**

- Requirement: **Required**

#### **Realm Settings - Brute Force Protection (ASVS 2.1.6 / 2.8.1)**

Security Defenses - Brute Force Detection

- Enable Brute Force Detection

- Set:

        Failure Threshold: 6

        Wait Increment: 60s

        Max Wait: 900s

#### Password Policies (ASVS 2.1.7)

Authentication - Policies

        Min length: >= 12
        Max length: <= 128

        Require at least 1: Uppercase, Digits, Special Character

        Password Expiry: 30 days
        
        Can't be username or email

        Password Reuse Prevention: not recently used in 30 days

#### Email Notification Triggers

Realm Settings - Login

- Enable **Verify Email**

Authentication - Flows - Account

- Enable Email Actions for user-triggered updates

#### Realm Settings - Events (ASVS 2.10.1, 2.10.2)

Events:
- Enable Event Logging
- Enable Admin Events

#### MANUAL SETTINGS needed

Authentication FLOWS
Associated roles to role Admin to give full control
Expiry password set to 60 days
Add client scopes for ROLES to make sure they appear in the token

### POSTMAN

For Token Retrieve
POST /realms/library/protocol/openid-connect/token

        {
        "client_id": "library-client",
        "client_secret": "...",
        "username": "admin",
        "password": "...",
        "grant_type": "password"
        }

### Security Features

| Feature                    | Description                                  | ASVS Mapping   |
| -------------------------- | -------------------------------------------- | -------------- |
| **Email Verification**     | On registration                              | 2.1.1, 2.1.3   |
| **TOTP/MFA**               | Default action & enforced in flow            | 2.1.4          |
| **Strong Password Policy** | Min length, uppercase, digits, special chars | 2.1.7          |
| **Account Lockout**        | Brute-force protection                       | 2.1.6, 2.8.1   |
| **Admin/API Logging**      | Events and Admin Logs                        | 2.10.1, 2.10.2 |

### Best Practices Mapped to OWASP ASVS

| Control             | Description                                              |
| ------------------- | -------------------------------------------------------- |
| **2.1.1 / 2.1.3**   | Verified emails before granting access                   |
| **2.1.4**           | Configured TOTP/MFA for all users                        |
| **2.1.6 / 2.8.1**   | Brute force protection: Lock after failed attempts attempts     |
| **2.1.7**           | Strong password policy (length, complexity, expiration)  |
| **2.10.1 / 2.10.2** | Enabled event logging and admin events                   |
| **2.9.1**           | Self-signed cert is not trusted; better to use real cert |
